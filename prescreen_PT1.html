<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>prescreen_PT1</title>
  <script src="https://unpkg.com/jspsych@7.3.4" type="text/javascript"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-html-form@1.0.3"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-multi-select@1.1.3"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-multi-choice@1.1.3"></script>
  <script src="https://unpkg.com/@jspsych/plugin-instructions@1.1.4"></script>
  <script src="https://unpkg.com/@jspsych-contrib/plugin-pipe"></script>
  <link rel="stylesheet" href="https://unpkg.com/jspsych@7.3.4/css/jspsych.css">
<style>  
ul {text-align: left;
list-style-position: inside;}
</style>  
</head>
<body>

</body>



<script>

  // Initialize jsPsych and create timeline -----------------------------------------------------------------
const jsPsych = initJsPsych({});
let sona_id = jsPsych.data.urlVariables()['sona_id'];
const filename = `${sona_id}.csv`;
var timeline = [];
let eligible = true;

// introductory text
var intro = {
    type: jsPsychInstructions,
    pages: [
    `Bonjour et merci pour l'intérêt que vous portez à notre étude.<br> 
    Ce premier questionnaire a pour objectif de vérifier que vous êtes éligible pour participer. A la fin de ce questionnaire (qui dure environ 2 minutes), vous pourrez retourner sur la page SONA de l'étude principale et choisir un créneau de RDV pour réaliser l'étude à l'Université.`
  ],
    show_clickable_nav: true
}
timeline.push(intro);


  // Age --------------------------------------------------------------------------
var age = {
  type: jsPsychSurveyHtmlForm,
  preamble: '<p><strong>Quel âge avez-vous ?</strong><br>Insérez un nombre ci-dessous.</p>',
  html: '<input type="number" id="age" name="age" min="0" max="100" required><br><br>',
  on_finish: function(data) {
    let resp = data.response || data.responses;
    if (typeof resp === 'string') resp = JSON.parse(resp);
    const age_value = parseInt(resp.age, 10);
    if (age_value < 18) {
      eligible = false;
      jsPsych.endExperiment('Merci, mais vous ne pouvez pas participer à cette étude car vous devez avoir au moins 18 ans.');
    }
  }
};
  timeline.push(age);


// Question de familiarité avec la conduite --------------------------------------------------------------------------
var expe_conduite = {
  type: jsPsychSurveyMultiSelect,
  questions: [
    {
      prompt: `Concernant votre expérience de conduite sur route, cochez la ou les cases qui s'appliquent à votre situation :`, 
      options: [
        `Je n'ai pas d'expérience de conduite`,
        `Je pratique (ou ai pratiqué) la conduite accompagnée`, 
        `Je suis en train de passer le permis voiture (permis B)`, 
        `J'ai le permis voiture (permis B)`, 
        `J'ai un permis de conduire autre que le permis B (par ex. BSR, permis A, permis A1)`, 
        `J'utilise (ou ai utilisé) une voiture sans permis`
      ], 
      horizontal: false,
      required: true
    }
  ], 
  randomize_question_order: false,
  data: { trial_name: 'expe_conduite' },
  on_finish: function(data) {
    let resp = data.response || data.responses;
    if (typeof resp === 'string') resp = JSON.parse(resp);

    // Le nom de la question est "Q0" par défaut pour la première question
    const reponses = resp.Q0;  

    if (reponses.includes(`Je n'ai pas d'expérience de conduite`)) {
      jsPsych.endExperiment('Merci, mais vous ne pouvez pas participer à cette étude sans expérience de conduite.');
    }
  }
}
timeline.push(expe_conduite);


// Questions de conduite à montrer conditionellement --------------------------------------------------------------------------
var durationsOptions = [
  `Il y a moins d'un mois`,
  `Il y a 1-3 mois`,
  `Il y a 4-6 mois`,
  `Il y a 7-9 mois`,
  `Il y a 10-12 mois`,
  `Il y a plus d'un an`
];

// Conduite accompagnée
var conduite_acc = {
  type: jsPsychSurveyMultiChoice,
  questions: [
    {
      prompt: "Quand avez-vous commencé la conduite accompagnée ?",
      options: durationsOptions,
      horizontal: false,
      required: true
    }
  ],
  on_finish: function(data) {
    var reponse = data.response.Q0; // Q0 = première (et unique) question

    if (reponse.includes(`Il y a plus d'un an`)) {
      eligible = false;
      jsPsych.endExperiment(
        `Merci, mais vous ne pouvez pas participer à cette étude car vous avez commencé la conduite accompagnée il y a plus d'un an.`
      );
    }
  }
};

// permis B
var permis_B_obtained = {
  type: jsPsychSurveyMultiChoice,
  questions: [
    {
      prompt: `Quand avez-vous commencé vos heures de conduite en auto-école en vue d'obtenir votre permis B ?`, 
      options: durationsOptions, 
      horizontal: false,
      required: true,
      name: 'permis_B_start_time'
    }, 
    {
      prompt: "Quand avez-vous obtenu votre permis B ?", 
      options: durationsOptions, 
      horizontal: false,
      required: true,
      name: 'permis_B_obtention_time'
    }
  ],  
  randomize_question_order: false,

  on_finish: function(data) {
    var responses = data.response;
    var start_time = responses.permis_B_start_time;
    var obtention_time = responses.permis_B_obtention_time;

    // Vérifie si au moins une réponse contient "plus d’un an"
    if (
      start_time.includes(`Il y a plus d'un an`) ||
      obtention_time.includes(`Il y a plus d'un an`)
    ) {
      eligible = false;
      jsPsych.endExperiment(
        `Merci, mais vous ne pouvez pas participer à cette étude car votre expérience de conduite remonte à plus d'un an.`
      );
    }
    // sinon, jsPsych continue naturellement
  }
};

var permis_B_not_yet_obtained = {
  type: jsPsychSurveyMultiChoice,
  questions: [
    {
      prompt: `Quand avez-vous commencé vos heures de conduite en auto-école en vue d'obtenir votre permis B ?`, 
      options: durationsOptions, 
      horizontal: false,
      required: true,
      name: 'permis_B_start_time'
    }
  ],  
  randomize_question_order: false,

  on_finish: function(data) {
    var responses = data.response;
    var start_time = responses.permis_B_start_time;
    var obtention_time = responses.permis_B_obtention_time;

    // Vérifie si au moins une réponse contient "plus d’un an"
    if (
      start_time.includes(`Il y a plus d'un an`) 
    ) {
      eligible = false;
      jsPsych.endExperiment(
        `Merci, mais vous ne pouvez pas participer à cette étude car votre expérience de conduite remonte à plus d'un an.`
      );
    }
    // sinon, jsPsych continue naturellement
  }
};


  var heures_conduite = {
    type: jsPsychSurveyHtmlForm,
    preamble: `<strong>Combien d'heures de conduite à l'auto-école avez-vous réalisées en vue d'obtenir le permis ? </strong><br>Insérez un nombre ci-dessous.`,
    html: '<input type="number" id="heures_conduite" name="heures_conduite" min="0" max="500" required><br><br>',
  };

  // autre permis
var autre_permis_nom = {
    type: jsPsychSurveyHtmlForm,
    preamble: '<p><strong>Quel type de permis autre que le permis B avez-vous ?</strong><br>Ecrivez ci-dessous.</p>',
    html: '<input type="text" id="autre_permis_nom" name="autre_permis_nom" required><br><br>',
  };

var permis_autre = {
  type: jsPsychSurveyMultiChoice,
  questions: [
    {
      prompt: `Quand avez-vous commencé vos heures de conduite en vue d'obtenir votre permis autre que le permis B ?`, 
      options: durationsOptions, 
      horizontal: false,
      required: true,
      name: 'permis_autre_start_time'
    }, 
    {
      prompt: "Quand avez-vous obtenu votre permis autre que le permis B ?", 
      options: durationsOptions, 
      horizontal: false,
      required: true,
      name: 'permis_autre_obtention_time'
    }
  ],  
  randomize_question_order: false,
on_finish: function(data) {
    var responses = data.response;
    var start_time = responses.permis_autre_start_time;
    var obtention_time = responses.permis_autre_obtention_time;

    // Vérifie si au moins une réponse contient "plus d’un an"
    if (
      start_time.includes(`Il y a plus d'un an`) ||
      obtention_time.includes(`Il y a plus d'un an`)
    ) {
      eligible = false;
      jsPsych.endExperiment(
        `Merci, mais vous ne pouvez pas participer à cette étude car votre expérience de conduite remonte à plus d'un an.`
      );
    }
    // sinon, jsPsych continue naturellement
  }
};

// véhicule sans permis
var vehic_sans_permis = {
  type: jsPsychSurveyMultiChoice,
  questions: [
    {
      prompt: "Quand avez-vous commencé à conduire votre voiture sans permis ?", 
      options: durationsOptions, 
      horizontal: false,
      required: true
    }
  ],
  on_finish: function(data) {
    var reponse = data.response.Q0; // Q0 = première (et unique) question

    if (reponse.includes(`Il y a plus d'un an`)) {
      eligible = false;
      jsPsych.endExperiment(
        `Merci, mais vous ne pouvez pas participer à cette étude car votre expérience de conduite remonte à plus d'un an.`
      );
    }
  }
};


// Conditional display node --------------------------------------------------------------------------

// conduite accompagnée
var if_conduite_acc = {
  timeline: [conduite_acc],
  conditional_function: function() {
    var data = jsPsych.data.get().filter({trial_name: 'expe_conduite'}).last(1).values()[0];
    var resp = data.response;
if (typeof resp === 'string') resp = JSON.parse(resp);
var response = resp["Q0"];
    return response.includes("Je pratique (ou ai pratiqué) la conduite accompagnée");
  }
};

// If "permis B" (either currently passing or already have it)
var if_permis_B_obtained = {
  timeline: [permis_B_obtained, heures_conduite],
  conditional_function: function() {
    var data = jsPsych.data.get().filter({trial_name: 'expe_conduite'}).last(1).values()[0];
    var resp = data.response;
if (typeof resp === 'string') resp = JSON.parse(resp);
var response = resp["Q0"];
    return (
      response.includes(`J'ai le permis voiture (permis B)`)
    );
  }
};
var if_permis_B_not_yet_obtained = {
  timeline: [permis_B_not_yet_obtained, heures_conduite],
  conditional_function: function() {
    var data = jsPsych.data.get().filter({trial_name: 'expe_conduite'}).last(1).values()[0];
    var resp = data.response;
if (typeof resp === 'string') resp = JSON.parse(resp);
var response = resp["Q0"];
    return (
      response.includes(`Je suis en train de passer le permis voiture (permis B)`) 
    );
  }
};
// If "autre permis"
var if_autre_permis = {
  timeline: [autre_permis_nom, permis_autre, heures_conduite],
  conditional_function: function() {
    var data = jsPsych.data.get().filter({trial_name: 'expe_conduite'}).last(1).values()[0];
    var resp = data.response;
if (typeof resp === 'string') resp = JSON.parse(resp);
var response = resp["Q0"];
    return response.includes(`J'ai un permis de conduire autre que le permis B (par ex. BSR, permis A, permis A1)`);
  }
};

// If "voiture sans permis"
var if_vehic_sans_permis = {
  timeline: [vehic_sans_permis],
  conditional_function: function() {
    var data = jsPsych.data.get().filter({trial_name: 'expe_conduite'}).last(1).values()[0];
    var resp = data.response;
if (typeof resp === 'string') resp = JSON.parse(resp);
var response = resp["Q0"];
    return response.includes(`J'utilise (ou ai utilisé) une voiture sans permis`);
  }
};


// Push to timeline
timeline.push(
  if_conduite_acc,
  if_permis_B_obtained,
  if_permis_B_not_yet_obtained,
  if_autre_permis,
  if_vehic_sans_permis
);

// Questions vulnérabilité --------------------------------------------------------------------------
var vulnerabilite = {
  type: jsPsychSurveyMultiChoice,
  questions: [
    {
      prompt: `<p>Si vous rentrez dans l'une des situations suivantes, cochez la case "Oui" ci-dessous. Sinon, cochez la case “Non”.</p>
              <ul>
                <li>Je souffre d'épilepsie photosensible</li>
                <li>J'ai le mal des transports</li>
                <li>J'ai un dysfonctionnement du système nerveux autonome</li>
                <li>Je suis enceinte</li>
                <li>J'ai un trouble vestibulaire</li>
                <li>J'ai un trouble de la proprioception</li>
                <li>J'ai un trouble oculomoteur</li>
                <li>Je souffre de migraines</li>
              </ul>`, 
      name: 'vulnerabilite', 
      options: ['Oui', 'Non'], 
      required: true
    }
  ],
  on_finish: function(data) {
    var reponse = data.response.vulnerabilite;

    if (reponse === 'Oui') {
      eligible = false;
      jsPsych.endExperiment('Merci de votre intérêt. Malheureusement, vous ne pouvez pas participer à cette étude pour des raisons de sécurité. <br> Vous pouvez fermer la page web.');
    } 
    else if (eligible) {  // ✅ Only redirect if still eligible
      // Message de redirection SONA
      document.body.innerHTML = `
        <div style="text-align:center; font-size:20px; margin-top:50px;">
          <p>Merci pour votre réponse, vous êtes éligible à l'étude.</p>
          <p>Vous allez être redirigé vers SONA, et un nouvel onglet va s'ouvrir pour que vous puissiez choisir un créneau de RDV.</p>
          <p><em>Redirection automatique dans quelques secondes...</em></p>
        </div>
      `;
      setTimeout(function(){
        window.location.href = "https://paris-nanterre.sona-systems.com/webstudy_credit.aspx?experiment_id=719&credit_token=2191cab625c04b3aa1b63b8af994ccf0&survey_code=" + sona_id;
        window.open("https://paris-nanterre.sona-systems.com/default.aspx?p_return_experiment_id=718", "_blank");
      }, 4000);
    }
  }
};
timeline.push(vulnerabilite);

const save_data = {
  type: jsPsychPipe,
  action: "save",
  experiment_id: "ngtrJSAVHJjS",
  filename: filename,
  data_string: ()=>jsPsych.data.get().csv()
};

timeline.push(save_data);
jsPsych.run(timeline);

</script>
</html>
